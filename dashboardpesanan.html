<!DOCTYPE html>
<html>
<head>
	<!-- Basic Page Info -->
	<meta charset="utf-8">
	<title>Dashboard KivRyelle</title>

	<!-- Site favicon -->
	<link rel="apple-touch-icon" sizes="180x180" href="vendors/images/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="vendors/images/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="vendors/images/favicon-16x16.png">

	<!-- Mobile Specific Metas -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<!-- Google Font -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
	<!-- CSS -->
	<link rel="stylesheet" type="text/css" href="vendors/styles/core.css">
	<link rel="stylesheet" type="text/css" href="vendors/styles/icon-font.min.css">
	<link rel="stylesheet" type="text/css" href="src/plugins/datatables/css/dataTables.bootstrap4.min.css">
	<link rel="stylesheet" type="text/css" href="src/plugins/datatables/css/responsive.bootstrap4.min.css">
	<link rel="stylesheet" type="text/css" href="vendors/styles/style.css">

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-119386393-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-119386393-1');
	</script>
    <style> .custom-btn { padding: 0.15rem 0.5rem; /* Adjust padding */ font-size: 0.6rem; /* Adjust font size */ } </style>
    <style> .modal-content { padding: 20px; } .product-image { width: 100px; /* Atur lebar gambar */ height: auto; /* Pastikan rasio tetap */ } </style>
</head>
<body>

	<div class="header">
		<div class="header-left">
			<div class="menu-icon dw dw-menu"></div>
			<div class="search-toggle-icon dw dw-search2" data-toggle="header_search"></div>
			<div class="header-search">
				<form>
					<div class="form-group mb-0">
						<i class="dw dw-search2 search-icon"></i>
						<input type="text" class="form-control search-input" placeholder="Search Here">
						<!-- <div class="dropdown">
							<a class="dropdown-toggle no-arrow" href="#" role="button" data-toggle="dropdown">
								<i class="ion-arrow-down-c"></i>
							</a>
							<div class="dropdown-menu dropdown-menu-right">
								<div class="form-group row">
									<label class="col-sm-12 col-md-2 col-form-label">From</label>
									<div class="col-sm-12 col-md-10">
										<input class="form-control form-control-sm form-control-line" type="text">
									</div>
								</div>
								<div class="form-group row">
									<label class="col-sm-12 col-md-2 col-form-label">To</label>
									<div class="col-sm-12 col-md-10">
										<input class="form-control form-control-sm form-control-line" type="text">
									</div>
								</div>
								<div class="form-group row">
									<label class="col-sm-12 col-md-2 col-form-label">Subject</label>
									<div class="col-sm-12 col-md-10">
										<input class="form-control form-control-sm form-control-line" type="text">
									</div>
								</div>
								<div class="text-right">
									<button class="btn btn-primary">Search</button>
								</div>
							</div>
						</div> -->
					</div>
				</form>
			</div>
		</div>
		<div class="header-right">
			
			<div class="user-info-dropdown">
				<div class="dropdown">
					<a class="dropdown-toggle" href="#" role="button" data-toggle="dropdown">
					  <span class="user-icon">
						<img src="vendors/images/photo1.jpg" alt="">
					  </span>
					  <span class="user-name" id="userName">Loading...</span>
					</a>
					<div class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list">
					  <a class="dropdown-item" id="profileLink" href="profile.html"><i class="dw dw-user1"></i> Profile</a>
					  <a class="dropdown-item" id="logoutButton" href="#"><i class="dw dw-logout"></i> Log Out</a>
					</div>
				  </div>
			</div>
			
		</div>
	</div>

	<div class="left-side-bar">
		<div class="brand-logo">
			<a href="">
				<!-- <img src="vendors/images/deskapp-logo-white.svg" alt="" class="light-logo">
				  -->
				<h1 style="color: white;"><span>Dashboard</span></h1>
			</a>
			<div class="close-sidebar" data-toggle="left-sidebar-close">
				<i class="ion-close-round"></i>
			</div>
		</div>
		<div class="menu-block customscroll">
			<div class="sidebar-menu">
				<ul id="accordion-menu">
					<li class="dropdown">
						<a href="dashboard.html" class="dropdown-toggle">
						  <span class="micon dw dw-house-1"></span><span class="mtext">Home</span>
						</a>
					  </li>
					  <li class="dropdown">
						<a href="dashboardproduct.html" class="dropdown-toggle">
						  <span class="micon dw dw-library"></span><span class="mtext">Product</span>
						</a>
					  </li>
					  <li class="dropdown">
						<a href="" class="dropdown-toggle">
						  <span class="micon dw dw-edit2"></span><span class="mtext">Pesanan</span>
						</a>
					  </li>
				</ul>
			</div>
		</div>
	</div>
	<div class="mobile-menu-overlay"></div>

	<div class="main-container">
		<div class="pd-ltr-20">
			<div class="card-box mb-30">
				<h2 class="h4 pd-20">Riwayat Seluruh Pesanan</h2>
				<table class="data table nowrap">
					<thead>
						<tr>
							<th>User</th>
							<th>Product</th>
							<th>Quantity</th>
							<th>Price</th>
							<th>Total Amount</th>
							<th>Order Status</th>
							<th>Order Date</th>
							<th>Shipping Address</th>
							<th>Payment Status</th>
							<th>Action</th>
						</tr>
					</thead>
					<tbody id="purchase-history-body">
						<!-- Data will be populated dynamically with JavaScript -->
					</tbody>
				</table>
			</div>
	
			<!-- User Details Modal -->
			<div class="modal" id="userModal" tabindex="-1" role="dialog">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">User Details</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body" id="user-details">
							<!-- User details will be displayed here -->
						</div>
					</div>
				</div>
			</div>
	
			<!-- Product Details Modal -->
			<div class="modal" id="productModal" tabindex="-1" role="dialog">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">Product Details</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body" id="product-details">
							<!-- Product details will be displayed here -->
						</div>
					</div>
				</div>
			</div>
	
			<!-- Shipping Address Modal -->
			<div class="modal" id="shippingModal" tabindex="-1" role="dialog">
				<div class="modal-dialog" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">Shipping Address</h5>
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body" id="shipping-address">
							<!-- Shipping address will be displayed here -->
						</div>
					</div>
				</div>
			</div>
	
			<div class="footer-wrap pd-20 mb-20 card-box">
				DeskApp - Bootstrap 4 Admin Template By <a href="https://github.com/dropways" target="_blank">Ankit Hingarajiya</a>
			</div>
		</div>
	</div>
		<!-- js -->
		<script src="vendors/scripts/core.js"></script>
		<script src="vendors/scripts/script.min.js"></script>
		<script src="vendors/scripts/process.js"></script>
		<script src="vendors/scripts/layout-settings.js"></script>
		<script src="src/plugins/apexcharts/apexcharts.min.js"></script>
		<script src="src/plugins/datatables/js/jquery.dataTables.min.js"></script>
		<script src="src/plugins/datatables/js/dataTables.bootstrap4.min.js"></script>
		<script src="src/plugins/datatables/js/dataTables.responsive.min.js"></script>
		<script src="src/plugins/datatables/js/responsive.bootstrap4.min.js"></script>
		<script src="vendors/scripts/dashboard.js"></script>

	</body>
	</html>
	<script src="js/auth.js"></script>
	<script>
	  document.addEventListener("DOMContentLoaded", async () => {
		// Check if the user is authenticated
		const token = localStorage.getItem("authToken");
	  
		if (!token) {
		  console.log("No token found. Redirecting to login page...");
		  window.location.href = "login.html";
		  return;
		}
	  
		try {
		  // Validate the token with the backend
		  const response = await fetch("public/validate_token.php", {
			method: "POST",
			headers: {
			  "Content-Type": "application/json",
			  Authorization: `Bearer ${token}`,
			},
		  });
	  
		  const data = await response.json();
	  
		  if (!data.success) {
			console.log("Invalid token. Redirecting to login page...");
			localStorage.removeItem("authToken"); // Remove invalid token
			window.location.href = "login.html";
			return;
		  }
	  
		  console.log("User is authenticated.");
	  
		  // Extract userId from the response or URL
		  const urlParams = new URLSearchParams(window.location.search);
		  const userId = urlParams.get("userId") || data.user.userId;
	  
		  // Fetch user data and update UI
		  if (userId) {
			fetchUserData(userId);
	  
			// Update links with userId
			updateLinksWithUserId(userId);
		  }
		} catch (error) {
		  console.error("Error validating token:", error);
		  localStorage.removeItem("authToken");
		  window.location.href = "login.html";
		}
	  
		// Attach logout functionality
		const logoutButton = document.getElementById("logoutButton");
		if (logoutButton) {
		  logoutButton.addEventListener("click", () => {
			localStorage.removeItem("authToken");
			console.log("User logged out. Redirecting to login page...");
			window.location.href = "login.html";
		  });
		}
	  });
	  
	  function updateLinksWithUserId(userId) {
		// Update Product link
		const productLink = document.querySelector('a[href="dashboardproduct.html"]');
		if (productLink) {
		  productLink.href = `dashboardproduct.html?userId=${userId}`;
		}
	  
		// Update Pesanan link
		const pesananLink = document.querySelector('a[href="dashboard.html"]');
		if (pesananLink) {
		  pesananLink.href = `dashboard.html?userId=${userId}`;
		}
	  
		// Add userId to profile link
		const profileLink = document.getElementById("profileLink");
		if (profileLink) {
		  profileLink.href = `profile.html?userId=${userId}`;
		}
	  }
	  
	  function fetchUserData(userId) {
		// Make a GET request to the PHP file
		fetch(`public/get_user.php?userId=${userId}`)
		  .then((response) => response.json()) // Parse JSON response
		  .then((data) => {
			if (data.error) {
			  console.error(data.error);
			} else {
			  // Update user name
			  const userNameElement = document.getElementById("userName");
			  if (userNameElement) {
				userNameElement.textContent = data.username || "User";
			  }
			}
		  })
		  .catch((error) => {
			console.error("An error occurred while fetching user data:", error);
		  });
	  }
	  </script>
	<script>
		let purchaseHistory = [];
		
		async function fetchAllPurchaseHistory() {
			try {
			  const response = await fetch("public/get_all_transactions.php");
			  const data = await response.json();
		  
			  if (data.error) {
				console.error("Error fetching purchase history:", data.error);
				alert(data.error);
				return;
			  }
		  
			  purchaseHistory = data; // Assign to global variable
			  populatePurchaseTable(purchaseHistory); // Populate table
			} catch (error) {
			  console.error("Error fetching purchase history:", error);
			  alert("An error occurred while fetching purchase history.");
			}
		  }
		  
		  
		  
		  
		  async function populatePurchaseTable(purchaseHistory) {
			const tableBody = document.getElementById("purchase-history-body");
			tableBody.innerHTML = ""; // Clear existing rows
		  
			for (const [index, purchase] of purchaseHistory.entries()) {
			  
			  const row = document.createElement("tr");
	
			  // User column
			  const userCell = document.createElement("td");
			  userCell.innerHTML = `<a href="#" onclick="showUserDetails(${index})">${purchase.user.username}</a>`;
			  row.appendChild(userCell);
	  
			  // Product column
			  const productCell = document.createElement("td");
			  productCell.innerHTML = `<a href="#" onclick="showProductDetails(${index})">${purchase.products[0].name}</a>`;
			  row.appendChild(productCell);
	  
			  // Quantity column
			  const quantityCell = document.createElement("td");
			  quantityCell.textContent = purchase.products[0].quantity;
			  row.appendChild(quantityCell);
	  
			  // Price column
			  const priceCell = document.createElement("td");
			  priceCell.textContent = `$${purchase.products[0].price}`;
			  row.appendChild(priceCell);
	  
			  // Total Amount column
			  const totalCell = document.createElement("td");
			  totalCell.textContent = `$${purchase.totalAmount}`;
			  row.appendChild(totalCell);
	  
			  // Order Status column
			  const statusCell = document.createElement("td");
			  statusCell.textContent = purchase.orderStatus;
			  row.appendChild(statusCell);
	  
			  // Order Date column
			  const orderDateCell = document.createElement("td");
			  orderDateCell.textContent = purchase.orderDate;
			  row.appendChild(orderDateCell);
	  
			  // Shipping Address column
			  const addressCell = document.createElement("td");
			  addressCell.innerHTML = `<a href="#" onclick="showShippingAddress(${index})">View Address</a>`;
			  row.appendChild(addressCell);
	  
			  // Payment Status column
			  const paymentStatusCell = document.createElement("td");
			  paymentStatusCell.textContent = purchase.payment.paymentStatus;
			  row.appendChild(paymentStatusCell);
	  
			  // Kolom tombol aksi
    const actionCell = document.createElement("td");
    actionCell.classList.add("order-action");

    if (purchase.payment.paymentStatus === "delivered") {
      // Jika status adalah "delivered", tampilkan teks "Menunggu Konfirmasi"
      actionCell.innerHTML = `<span class="text-success">Menunggu Konfirmasi</span>`;
    } else {
      // Tambahkan tombol Update Status
      const updateButton = document.createElement("button");
      updateButton.classList.add("btn", "btn-primary", "btn-sm");
      updateButton.textContent = "Update Status";
      updateButton.addEventListener("click", () => updateOrderStatus(index));
      actionCell.appendChild(updateButton);
    }
			  row.appendChild(actionCell);
	  
			  tableBody.appendChild(row);
			}
		  }

		
			
		
	
		  function updateOrderStatus(index) {
			const statusOrder = ["shipping", "delivered"];
			const currentIndex = statusOrder.indexOf(purchaseHistory[index].orderStatus);
		
			if (currentIndex < statusOrder.length - 1) {
				const newStatus = statusOrder[currentIndex + 1];
		
				// Update ke API menggunakan _id
				fetch("path/to/update_order_status_api.php", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({
						id: purchaseHistory[index]._id, // Kirim _id dari MongoDB
						newStatus: newStatus,
					}),
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						alert(`Order status updated to ${newStatus}`);
						purchaseHistory[index].orderStatus = newStatus;
		
						// Sembunyikan tombol jika status delivered
						if (newStatus === "delivered") {
							document.getElementById(`statusButton-${index}`).style.display = "none";
							document.getElementById(`confirmationText-${index}`).style.display = "block"; // Tampilkan teks konfirmasi
						}
					} else {
						alert(data.message);
					}
				})
				.catch(error => {
					console.error("Error updating status:", error);
					alert("Failed to update order status.");
				});
			} else {
				alert("Order is already delivered.");
			}
		}
		
		  
	
		document.addEventListener("DOMContentLoaded", fetchAllPurchaseHistory);
	  
	  
	  function showUserDetails(index) {
		const user = purchaseHistory[index].user;
		const userDetails = document.getElementById("user-details");
		if (!user) return;
		userDetails.innerHTML = `
		  <p>Username: ${user.username || "N/A"}</p>
		  <p>Email: ${user.email || "N/A"}</p>
		  <p>Phone: ${user.phone || "N/A"}</p>
		  <p>Role: ${user.role || "N/A"}</p>
		`;
		$('#userModal').modal('show');
	  }
	  
	  function showProductDetails(index) {
		const product = purchaseHistory[index]?.products?.[0];
		if (!product) return;
		const productDetails = document.getElementById("product-details");
		productDetails.innerHTML = `
		  <p>Product Name: ${product.name || "N/A"}</p>
		  <p>Quantity: ${product.quantity || "N/A"}</p>
		  <p>Price: $${product.price || "0.00"}</p>
		`;
		$('#productModal').modal('show');
	  }

	  function showShippingAddress(index) {
		const address = purchaseHistory[index]?.shippingAddress;
		if (!address) return;
	  
		const shippingDetails = document.getElementById("shipping-address");
		shippingDetails.innerHTML = `
		  <p>Street: ${address.street || "N/A"}</p>
		  <p>City: ${address.city || "N/A"}</p>
		  <p>State: ${address.state || "N/A"}</p>
		  <p>Postal Code: ${address.postalCode || "N/A"}</p>
		`;
		$('#shippingModal').modal('show'); // Trigger modal display
	  }
	</script>
	